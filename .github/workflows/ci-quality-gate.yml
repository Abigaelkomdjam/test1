name: Quality Gate + AI Feedback (Gemini)

on:
  push:
    branches: [ master ]

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      errors: ${{ steps.check.outputs.errors }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install mypy pylint
      - run: mypy . --strict --pretty > mypy.txt || true
      - run: pylint *.py --score=n > pylint.txt || true
      - id: check
        run: |
          ERR=""
          if grep -q "error:" mypy.txt; then
            ERR="${ERR}=== MYPY ERRORS ===\n$(cat mypy.txt)\n\n"
          fi
          if grep -q "rated at" pylint.txt; then
            SCORE=$(tail -n1 pylint.txt | grep -o "[0-9.]*" | head -1)
            if (( $(echo "$SCORE < 9" | bc -l) )); then
              ERR="${ERR}=== PYLINT (Score: $SCORE/10) ===\n$(cat pylint.txt)\n"
            fi
          fi
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo "$ERR" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  ai:
    needs: check
    if: needs.check.outputs.errors != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Debug - Show raw errors
        run: |
          echo "=== ERREURS BRUTES ==="
          echo "${{ needs.check.outputs.errors }}"

      - name: Call Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "ERREUR: GEMINI_API_KEY manquant dans les secrets GitHub"
            echo "Fallback: pas de correction IA" > ai_fix.txt
            exit 0
          fi

          PROMPT="Tu es un expert Python. Corrige ces erreurs de code (typage mypy et style pylint). Pour chaque erreur, donne :\n- Fichier + ligne\n- ProblÃ¨me\n- Correction (code complet)\n- Explication courte\n\nStyle : direct, brutal, en franÃ§ais.\n\nErreurs :\n${{ needs.check.outputs.errors }}"

          echo "Envoi Ã  Gemini..."
          curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "contents": [{
                "parts": [{
                  "text": "'"$PROMPT"'"
                }]
              }],
              "generationConfig": {
                "temperature": 0.2
              }
            }' > ai_response.json || echo "CURL Ã©chouÃ©" > ai_response.json

          cat ai_response.json

          if grep -q '"text"' ai_response.json 2>/dev/null; then
            # Extrait le texte de la rÃ©ponse Gemini
            jq -r '.candidates[0].content.parts[0].text // "Aucune rÃ©ponse de l'\''IA"' ai_response.json > ai_fix.txt
          else
            echo "Erreur API Gemini (clÃ© invalide ou quota dÃ©passÃ©)" > ai_fix.txt
            cat ai_response.json >> ai_fix.txt
          fi

      - name: Debug - Show AI output
        run: |
          echo "=== RÃ‰PONSE GEMINI (ai_fix.txt) ==="
          cat ai_fix.txt

      - uses: actions/upload-artifact@v3
        with:
          name: ai-fix
          path: ai_fix.txt

  email:
    needs: [check, ai]
    if: needs.check.outputs.errors != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: ai-fix

      - name: Build email
        run: |
          ERRORS="${{ needs.check.outputs.errors }}"
          AI_FIX=$(cat ai_fix.txt)

          cat > email_body.txt << EOM
# ðŸš¨ CI BLOQUÃ‰ - Corrections requises

**Salut ${{ github.actor }} !**

Ton push sur **master** a Ã©tÃ© **bloquÃ©** par le Quality Gate. Voici les dÃ©tails :

## ðŸ” Lien vers le run CI
[Voir les logs complets](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

## âŒ Erreurs dÃ©tectÃ©es
\`\`\`
$ERRORS
\`\`\`

## ðŸ¤– Corrections proposÃ©es par IA (Gemini)
$AI_FIX

**Action requise** : Corrige selon les suggestions, commit et repousse. Le merge ne passera que si tout est vert !

â€” Ton Quality Gate IA
EOM

      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "ðŸš¨ CI BLOQUÃ‰ - Erreurs dans ${{ github.repository }} (commit ${{ github.sha }})"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Quality Gate <no-reply@github.com>"
          content_type: 'text/html'
          convert_markdown: true
          body: file://email_body.txt
