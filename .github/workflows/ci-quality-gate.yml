name: Quality Gate + AI Feedback (Gemini)

on:
  push:
    branches: [ master ]

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      errors: ${{ steps.check.outputs.errors }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install mypy pylint requests
      - run: mypy . --strict --pretty > mypy.txt || true
      - run: pylint *.py --score=n > pylint.txt || true
      - id: check
        run: |
          ERR=""
          if grep -q "error:" mypy.txt; then ERR+="$(cat mypy.txt)\n\n"; fi
          if grep -q "rated at" pylint.txt; then
            SCORE=$(tail -n1 pylint.txt | grep -o "[0-9.]*" | head -1)
            if (( $(echo "$SCORE < 9" | bc -l) )); then ERR+="$(cat pylint.txt)\n"; fi
          fi
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -n "$ERR" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  ai:
    needs: check
    if: needs.check.outputs.errors != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install requests

      - name: Debug - Show errors
        run: echo "${{ needs.check.outputs.errors }}"

      - name: Run Gemini script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "${{ needs.check.outputs.errors }}" | python scripts/ai_gemini.py > ai_fix.txt
          echo "=== RÉPONSE GEMINI ==="
          cat ai_fix.txt

      - uses: actions/upload-artifact@v3
        with:
          name: ai-fix
          path: ai_fix.txt

  email:
    needs: [check, ai]
    if: needs.check.outputs.errors != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: ai-fix

      - name: Build email
        run: |
          ERRORS="${{ needs.check.outputs.errors }}"
          AI_FIX=$(cat ai_fix.txt)

          cat > email_body.txt << EOM
# CI BLOQUÉ

**Salut ${{ github.actor }} !**

Push bloqué sur **master**.

## Lien
[Voir le run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

## Erreurs
\`\`\`
$ERRORS
\`\`\`

## Corrections IA (Gemini)
\`\`\`
$AI_FIX
\`\`\`

**Corrige et repousse.**

— Quality Gate
EOM

      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "CI BLOQUÉ - ${{ github.repository }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "Quality Gate <no-reply@github.com>"
          content_type: text/html
          convert_markdown: true
          body: file://email_body.txt
