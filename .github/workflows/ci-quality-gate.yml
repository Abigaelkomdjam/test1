name: Quality Gate + AI Feedback (Gemini)

on:
  push:
    branches: [ master ]

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      errors: ${{ steps.check.outputs.errors }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install mypy pylint
      - run: mypy . --strict --pretty > mypy.txt || true
      - run: pylint *.py --score=n > pylint.txt || true
      - id: check
        run: |
          ERR=""
          if grep -q "error:" mypy.txt; then
            ERR="${ERR}=== MYPY ERRORS ===\n$(cat mypy.txt)\n\n"
          fi
          if grep -q "rated at" pylint.txt; then
            SCORE=$(tail -n1 pylint.txt | grep -o "[0-9.]*" | head -1)
            if (( $(echo "$SCORE < 9" | bc -l) )); then
              ERR="${ERR}=== PYLINT (Score: $SCORE/10) ===\n$(cat pylint.txt)\n"
            fi
          fi
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo "$ERR" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  ai:
    needs: check
    if: needs.check.outputs.errors != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Debug - Show raw errors
        run: |
          echo "=== ERREURS BRUTES ==="
          echo "${{ needs.check.outputs.errors }}"

      - name: Call Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "ERREUR: GEMINI_API_KEY manquant"
            echo "Fallback: pas de correction IA" > ai_fix.txt
            exit 0
          fi

          PROMPT=$(cat << 'PROMPT'
Tu es un expert Python. Corrige ces erreurs (mypy + pylint). Pour chaque erreur :
- Fichier + ligne
- Problème
- Correction (code)
- Explication courte

Style : direct, brutal, en français.

Erreurs :
${{ needs.check.outputs.errors }}
PROMPT
          )

          echo "Envoi à Gemini..."
          curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"contents\":[{\"parts\":[{\"text\":$(printf '%s' \"$PROMPT\" | jq -R .)}]}]}" > ai_response.json || echo "CURL échoué" > ai_response.json

          cat ai_response.json

          if jq -e '.candidates[0].content.parts[0].text' ai_response.json > /dev/null 2>&1; then
            jq -r '.candidates[0].content.parts[0].text' ai_response.json > ai_fix.txt
          else
            echo "Erreur API Gemini" > ai_fix.txt
            cat ai_response.json >> ai_fix.txt
          fi

      - name: Debug - Show AI output
        run: |
          echo "=== RÉPONSE GEMINI ==="
          cat ai_fix.txt

      - uses: actions/upload-artifact@v3
        with:
          name: ai-fix
          path: ai_fix.txt

  email:
    needs: [check, ai]
    if: needs.check.outputs.errors != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: ai-fix

      - name: Build email
        run: |
          ERRORS="${{ needs.check.outputs.errors }}"
          AI_FIX=$(cat ai_fix.txt)

          cat > email_body.txt << EOM
# CI BLOQUÉ

**Salut ${{ github.actor }} !**

Push sur **master** bloqué.

## Lien CI
[Voir le run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

## Erreurs
\`\`\`
$ERRORS
\`\`\`

## Corrections IA (Gemini)
\`\`\`
$AI_FIX
\`\`\`

**Corrige et repousse.**

— Quality Gate
EOM

      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "CI BLOQUÉ - ${{ github.repository }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "Quality Gate <no-reply@github.com>"
          content_type: text/html
          convert_markdown: true
          body: file://email_body.txt
