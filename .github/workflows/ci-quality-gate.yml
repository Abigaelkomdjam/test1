name: Quality Gate + AI Feedback

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    outputs:
      has_errors: ${{ steps.check.outputs.has_errors }}
      error_details: ${{ steps.check.outputs.error_details }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy pylint types-requests  # ajoute d'autres types si besoin
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run mypy
        id: mypy
        continue-on-error: true
        run: |
          mypy . --strict --pretty > mypy_output.txt || echo "mypy_failed=true" >> $GITHUB_ENV
          cat mypy_output.txt

      - name: Run pylint
        id: pylint
        continue-on-error: true
        run: |
          pylint $(git ls-files '*.py') --reports=n --score=n > pylint_output.txt || echo "pylint_failed=true" >> $GITHUB_ENV
          cat pylint_output.txt

      - name: Check for errors
        id: check
        run: |
          ERROR=""
          HAS_ERROR="false"

          if [ -f mypy_output.txt ] && grep -q "error:" mypy_output.txt; then
            ERROR="${ERROR}MYPI ERRORS:\n$(cat mypy_output.txt)\n\n"
            HAS_ERROR="true"
          fi

          if [ -f pylint_output.txt ] && grep -q "rated at" pylint_output.txt; then
            SCORE=$(tail -n 1 pylint_output.txt | grep -o "rated at [0-9.]*" | cut -d' ' -f3)
            if (( $(echo "$SCORE < 9.0" | bc -l) )); then
              ERROR="${ERROR}PYLINT SCORE: $SCORE/10 (min 9.0)\n$(cat pylint_output.txt)\n\n"
              HAS_ERROR="true"
            fi
          fi

          echo "has_errors=$HAS_ERROR" >> $GITHUB_OUTPUT
          echo "error_details<<EOF" >> $GITHUB_OUTPUT
          echo "$ERROR" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  ai-feedback:
    needs: quality-check
    if: ${{ needs.quality-check.outputs.has_errors == 'true' }}
    runs-on: ubuntu-latest
    env:
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }} # ou OPENAI_API_KEY
      DEVELOPER: ${{ github.actor }}

    steps:
      - name: Download error logs
        uses: actions/download-artifact@v3
        with:
          name: error-logs

      - name: Load developer profile (bonus)
        id: profile
        run: |
          PROFILE="default"
          if [ -f "dev_profiles.json" ]; then
            jq -r ".[\"$DEVELOPER\"] // \"direct, concise\"" dev_profiles.json || echo "direct, concise"
          else
            echo "direct, concise"
          fi

      - name: Generate AI feedback
        run: |
          ERROR_DETAILS="${{ needs.quality-check.outputs.error_details }}"
          PROFILE_STYLE="${{ steps.profile.outputs.result }}"

          PROMPT=$(cat <<EOF
          Tu es un expert Python strict mais pédagogue. 
          Voici les erreurs détectées dans le code :

          $ERROR_DETAILS

          Donne une correction **précise** pour chaque erreur :
          - Fichier + ligne
          - Problème
          - Correction (code)
          - Explication courte

          Adapte ton ton au style du développeur : **$PROFILE_STYLE**
          Sois direct, concis, sans politesse inutile.
          Réponds en français.
          EOF
          )

          curl -X POST https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $GROK_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "grok-beta",
              "messages": [{"role": "user", "content": "'"$PROMPT"'"}],
              "temperature": 0.3
            }' > ai_feedback.json

          cat ai_feedback.json | jq -r '.choices[0].message.content' > ai_suggestion.txt

      - name: Upload AI feedback
        uses: actions/upload-artifact@v3
        with:
          name: ai-feedback
          path: ai_suggestion.txt

  send-email:
    needs: [quality-check, ai-feedback]
    if: ${{ needs.quality-check.outputs.has_errors == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download AI feedback
        uses: actions/download-artifact@v3
        with:
          name: ai-feedback

      - name: Send detailed email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "CI BLOQUÉ – Corrige ton code (${{ github.actor }})"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub CI <no-reply@github.com>"
          secure: true
          body: |
            Salut ${{ github.actor }},

            Ton push a été **bloqué** car le code ne passe pas les vérifications.

            Lien CI : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            === ERREURS DÉTECTÉES ===
            ${{ needs.quality-check.outputs.error_details }}

            === CORRECTIONS PROPOSÉES PAR IA ===
            $(cat ai_suggestion.txt)

            Corrige et repousse. Pas de merge tant que ce n’est pas vert.

            — L’IA Quality Gate
